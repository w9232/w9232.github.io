<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>幸运抓阄 - 多人在线抽签工具</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- 引入Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js"></script>
  
  <!-- Tailwind 配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3B82F6',
            secondary: '#10B981',
            accent: '#F59E0B',
            dark: '#1F2937',
            light: '#F9FAFB'
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .animate-spin-slow {
        animation: spin 3s linear infinite;
      }
      .animate-bounce-slow {
        animation: bounce 2s infinite;
      }
      .card-hover {
        transition: all 0.3s ease;
      }
      .card-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }
    }
  </style>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-50 min-h-screen font-sans text-dark">
  <!-- 顶部导航 -->
  <header class="bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-50 transition-all duration-300">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center space-x-2">
        <i class="fa fa-random text-primary text-2xl"></i>
        <h1 class="text-[clamp(1.25rem,3vw,1.75rem)] font-bold text-dark">幸运抓阄</h1>
      </div>
      <div class="flex items-center space-x-4">
        <span id="online-count" class="hidden md:flex items-center text-sm bg-primary/10 text-primary px-3 py-1 rounded-full">
          <i class="fa fa-users mr-1"></i>
          <span>在线: <span id="user-count">1</span></span>
        </span>
        <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
          <i class="fa fa-moon-o text-gray-600"></i>
        </button>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8 max-w-5xl">
    <!-- 房间设置 -->
    <div class="bg-white rounded-xl shadow-md p-6 mb-8 transform transition-all hover:shadow-lg">
      <h2 class="text-xl font-semibold mb-4 text-primary">房间设置</h2>
      <div class="flex flex-wrap gap-4 items-center">
        <div class="flex-1 min-w-[250px]">
          <label class="block text-sm font-medium text-gray-700 mb-1">房间ID（共享此ID让他人加入）</label>
          <div class="flex">
            <input 
              type="text" 
              id="room-id" 
              placeholder="输入房间ID或留空自动生成" 
              class="flex-1 px-4 py-2 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
            >
            <button 
              id="join-room" 
              class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-r-lg transition-all whitespace-nowrap"
            >
              加入/创建房间
            </button>
          </div>
        </div>
        <div>
          <button 
            id="copy-room-id" 
            class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition-all flex items-center"
            disabled
          >
            <i class="fa fa-copy mr-1"></i> 复制房间ID
          </button>
        </div>
      </div>
      <div id="sync-status" class="mt-3 text-sm text-gray-500 flex items-center">
        <i class="fa fa-circle-o-notch fa-spin mr-1"></i>
        <span>未连接到服务器</span>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- 左侧：参与者管理 -->
      <div class="lg:col-span-1 space-y-6">
        <!-- 添加参与者 -->
        <div class="bg-white rounded-xl shadow-md p-6 card-hover">
          <h3 class="text-lg font-semibold mb-4 flex items-center">
            <i class="fa fa-user-plus text-primary mr-2"></i>
            添加参与者
          </h3>
          <div class="flex gap-2">
            <input 
              type="text" 
              id="participant-name" 
              placeholder="输入参与者姓名" 
              class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
              disabled
            >
            <button 
              id="add-participant" 
              class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg transition-all flex items-center"
              disabled
            >
              <i class="fa fa-plus mr-1"></i> 添加
            </button>
          </div>
          <div class="mt-4 text-sm text-gray-500">
            <i class="fa fa-info-circle mr-1"></i>
            <span>最多可添加30名参与者</span>
          </div>
        </div>

        <!-- 参与者列表 -->
        <div class="bg-white rounded-xl shadow-md p-6 card-hover">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold flex items-center">
              <i class="fa fa-list-ul text-primary mr-2"></i>
              参与者列表
            </h3>
            <span id="participant-count" class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-full">
              0人
            </span>
          </div>
          
          <div id="participants-container" class="max-h-[300px] overflow-y-auto pr-2 space-y-2">
            <div class="text-center text-gray-400 py-8 border border-dashed border-gray-200 rounded-lg">
              <i class="fa fa-users text-3xl mb-2 opacity-30"></i>
              <p>请先创建或加入房间</p>
            </div>
          </div>
          
          <div class="mt-4 flex justify-between">
            <button 
              id="clear-participants" 
              class="text-gray-500 hover:text-red-500 text-sm transition-colors flex items-center opacity-70 hover:opacity-100"
              disabled
            >
              <i class="fa fa-trash mr-1"></i> 清空列表
            </button>
            <button 
              id="import-names" 
              class="text-gray-500 hover:text-primary text-sm transition-colors flex items-center"
              disabled
            >
              <i class="fa fa-upload mr-1"></i> 批量导入
            </button>
          </div>
        </div>
      </div>

      <!-- 右侧：抽签区域 -->
      <div class="lg:col-span-2 space-y-6">
        <!-- 抽签控制区 -->
        <div class="bg-white rounded-xl shadow-md p-6 card-hover">
          <h3 class="text-lg font-semibold mb-4 flex items-center">
            <i class="fa fa-random text-accent mr-2"></i>
            抽签区
          </h3>
          
          <div class="flex flex-col items-center py-6">
            <div id="draw-result" class="mb-8 w-full max-w-md h-40 flex items-center justify-center border-2 border-dashed border-gray-200 rounded-xl bg-gray-50 transition-all">
              <div class="text-center text-gray-400">
                <i class="fa fa-trophy text-4xl mb-2 opacity-30"></i>
                <p>请先创建或加入房间</p>
              </div>
            </div>
            
            <button 
              id="start-draw" 
              class="bg-accent hover:bg-accent/90 text-white px-8 py-3 rounded-lg text-lg font-medium transition-all transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-accent/50 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
              disabled
            >
              <i class="fa fa-play mr-2"></i> 开始抽签
            </button>
          </div>
        </div>

        <!-- 历史记录 -->
        <div class="bg-white rounded-xl shadow-md p-6 card-hover">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold flex items-center">
              <i class="fa fa-history text-primary mr-2"></i>
              抽签历史
            </h3>
            <button 
              id="clear-history" 
              class="text-gray-500 hover:text-red-500 text-sm transition-colors flex items-center opacity-70 hover:opacity-100"
              disabled
            >
              <i class="fa fa-trash mr-1"></i> 清空历史
            </button>
          </div>
          
          <div id="history-container" class="max-h-[200px] overflow-y-auto space-y-3">
            <div class="text-center text-gray-400 py-6 border border-dashed border-gray-200 rounded-lg">
              <p>请先创建或加入房间</p>
            </div>
          </div>
        </div>

        <!-- 使用说明 -->
        <div class="bg-white rounded-xl shadow-md p-6 card-hover">
          <h3 class="text-lg font-semibold mb-4 flex items-center">
            <i class="fa fa-info-circle text-primary mr-2"></i>
            使用说明
          </h3>
          
          <ul class="space-y-2 text-gray-600 text-sm">
            <li class="flex items-start">
              <i class="fa fa-check-circle text-secondary mt-1 mr-2"></i>
              <span>创建房间并分享房间ID给参与者</span>
            </li>
            <li class="flex items-start">
              <i class="fa fa-check-circle text-secondary mt-1 mr-2"></i>
              <span>参与者输入相同的房间ID即可加入</span>
            </li>
            <li class="flex items-start">
              <i class="fa fa-check-circle text-secondary mt-1 mr-2"></i>
              <span>主持人添加所有参与抽签的人员名单</span>
            </li>
            <li class="flex items-start">
              <i class="fa fa-check-circle text-secondary mt-1 mr-2"></i>
              <span>点击"开始抽签"按钮，系统将随机选择一名幸运者</span>
            </li>
            <li class="flex items-start">
              <i class="fa fa-check-circle text-secondary mt-1 mr-2"></i>
              <span>抽签结果将实时展示给所有在线参与者</span>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </main>

  <!-- 批量导入模态框 -->
  <div id="import-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6 transform transition-all scale-95 opacity-0" id="modal-content">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">批量导入参与者</h3>
        <button id="close-modal" class="text-gray-400 hover:text-gray-600">
          <i class="fa fa-times"></i>
        </button>
      </div>
      <p class="text-sm text-gray-500 mb-4">请输入参与者姓名，每行一个</p>
      <textarea 
        id="batch-names" 
        rows="8" 
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all text-sm"
        placeholder="张三&#10;李四&#10;王五&#10;..."></textarea>
      <div class="mt-4 flex justify-end gap-2">
        <button id="cancel-import" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-50 transition-colors">
          取消
        </button>
        <button id="confirm-import" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
          确认导入
        </button>
      </div>
    </div>
  </div>

  <!-- 底部信息 -->
  <footer class="bg-white/80 backdrop-blur-md mt-12 py-6 border-t">
    <div class="container mx-auto px-4 text-center text-gray-500 text-sm">
      <p>幸运抓阄 &copy; 2023 - 公平、公正、公开的在线抽签工具</p>
    </div>
  </footer>

  <script>
    // Firebase 配置 - 请替换为你自己的Firebase配置
    const firebaseConfig = {
      apiKey: "AIzaSyCqFbJZxX9tRzX5G7z9QZ5QZ5QZ5QZ5QZ5",
      authDomain: "draw-tool-example.firebaseapp.com",
      databaseURL: "https://draw-tool-example-default-rtdb.firebaseio.com",
      projectId: "draw-tool-example",
      storageBucket: "draw-tool-example.appspot.com",
      messagingSenderId: "1234567890",
      appId: "1:1234567890:web:1234567890abcdef"
    };

    // 初始化Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // 全局状态管理
    const state = {
      participants: [],
      history: [],
      isDrawing: false,
      currentWinner: null,
      roomId: null,
      isConnected: false,
      userId: generateUserId() // 生成唯一用户ID
    };

    // 生成唯一用户ID
    function generateUserId() {
      return 'user_' + Math.random().toString(36).substr(2, 9);
    }

    // 生成随机房间ID
    function generateRoomId() {
      return Math.random().toString(36).substr(2, 8).toUpperCase();
    }

    // DOM元素
    const elements = {
      roomId: document.getElementById('room-id'),
      joinRoom: document.getElementById('join-room'),
      copyRoomId: document.getElementById('copy-room-id'),
      syncStatus: document.getElementById('sync-status'),
      participantName: document.getElementById('participant-name'),
      addParticipant: document.getElementById('add-participant'),
      participantsContainer: document.getElementById('participants-container'),
      participantCount: document.getElementById('participant-count'),
      clearParticipants: document.getElementById('clear-participants'),
      startDraw: document.getElementById('start-draw'),
      drawResult: document.getElementById('draw-result'),
      historyContainer: document.getElementById('history-container'),
      clearHistory: document.getElementById('clear-history'),
      importNames: document.getElementById('import-names'),
      importModal: document.getElementById('import-modal'),
      modalContent: document.getElementById('modal-content'),
      closeModal: document.getElementById('close-modal'),
      cancelImport: document.getElementById('cancel-import'),
      confirmImport: document.getElementById('confirm-import'),
      batchNames: document.getElementById('batch-names'),
      userCount: document.getElementById('user-count'),
      themeToggle: document.getElementById('theme-toggle')
    };

    // 初始化
    function init() {
      // 设置事件监听
      setupEventListeners();
      
      // 尝试从URL加载房间ID
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('room')) {
        elements.roomId.value = urlParams.get('room');
      }
    }

    // 事件监听设置
    function setupEventListeners() {
      // 房间相关
      elements.joinRoom.addEventListener('click', joinOrCreateRoom);
      elements.copyRoomId.addEventListener('click', copyRoomIdToClipboard);
      
      // 添加参与者
      elements.addParticipant.addEventListener('click', addParticipant);
      
      // 按Enter键添加参与者
      elements.participantName.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          addParticipant();
        }
      });
      
      // 清空参与者
      elements.clearParticipants.addEventListener('click', clearParticipants);
      
      // 开始抽签
      elements.startDraw.addEventListener('click', startDraw);
      
      // 清空历史
      elements.clearHistory.addEventListener('click', clearHistory);
      
      // 批量导入相关
      elements.importNames.addEventListener('click', openImportModal);
      elements.closeModal.addEventListener('click', closeImportModal);
      elements.cancelImport.addEventListener('click', closeImportModal);
      elements.confirmImport.addEventListener('click', importParticipants);
      
      // 主题切换
      elements.themeToggle.addEventListener('click', toggleTheme);
    }

    // 加入或创建房间
    function joinOrCreateRoom() {
      let roomId = elements.roomId.value.trim();
      
      // 如果没有输入房间ID，自动生成一个
      if (!roomId) {
        roomId = generateRoomId();
        elements.roomId.value = roomId;
      }
      
      // 保存房间ID
      state.roomId = roomId;
      
      // 更新UI
      elements.copyRoomId.disabled = false;
      updateSyncStatus('connecting', '正在连接到房间...');
      
      // 更新URL，方便分享
      const url = new URL(window.location.href);
      url.searchParams.set('room', roomId);
      window.history.pushState({}, '', url);
      
      // 连接到Firebase实时数据库
      connectToRoom(roomId);
    }

    // 连接到房间
    function connectToRoom(roomId) {
      // 房间数据的数据库路径
      const roomRef = database.ref(`rooms/${roomId}`);
      
      // 监听房间数据变化
      roomRef.on('value', (snapshot) => {
        const data = snapshot.val();
        
        // 如果房间不存在，初始化数据
        if (!data) {
          roomRef.set({
            participants: [],
            history: [],
            onlineUsers: {}
          });
          return;
        }
        
        // 更新本地状态
        state.participants = data.participants || [];
        state.history = data.history || [];
        
        // 更新UI
        renderParticipants();
        renderHistory();
        updateButtonsState();
        
        // 标记为已连接
        if (!state.isConnected) {
          state.isConnected = true;
          updateSyncStatus('connected', '已连接到房间，数据实时同步中');
          
          // 启用交互控件
          elements.participantName.disabled = false;
          elements.addParticipant.disabled = false;
          elements.importNames.disabled = false;
        }
        
        // 更新在线用户计数
        updateOnlineUsers(roomRef);
      });
      
      // 监听连接状态
      database.ref('.info/connected').on('value', (snapshot) => {
        if (snapshot.val() === false) {
          return;
        }
        
        // 记录当前用户在线状态
        const userRef = roomRef.child(`onlineUsers/${state.userId}`);
        
        // 当用户断开连接时（关闭页面等），自动移除在线状态
        userRef.onDisconnect().remove();
        
        // 设置用户在线
        userRef.set(true);
      });
      
      // 监听在线用户变化
      roomRef.child('onlineUsers').on('value', (snapshot) => {
        const onlineUsers = snapshot.val() || {};
        const userCount = Object.keys(onlineUsers).length;
        elements.userCount.textContent = userCount;
      });
      
      // 保存房间引用，用于后续数据更新
      state.roomRef = roomRef;
    }

    // 更新在线用户
    function updateOnlineUsers(roomRef) {
      // 标记当前用户在线
      roomRef.child(`onlineUsers/${state.userId}`).set(true);
    }

    // 更新同步状态
    function updateSyncStatus(status, message) {
      const icon = elements.syncStatus.querySelector('i');
      const text = elements.syncStatus.querySelector('span');
      
      // 移除所有状态类
      elements.syncStatus.classList.remove('text-green-600', 'text-yellow-600', 'text-red-600');
      icon.className = '';
      
      // 设置状态
      switch(status) {
        case 'connected':
          elements.syncStatus.classList.add('text-green-600');
          icon.className = 'fa fa-check-circle mr-1';
          break;
        case 'connecting':
          elements.syncStatus.classList.add('text-yellow-600');
          icon.className = 'fa fa-circle-o-notch fa-spin mr-1';
          break;
        case 'error':
          elements.syncStatus.classList.add('text-red-600');
          icon.className = 'fa fa-exclamation-circle mr-1';
          break;
      }
      
      text.textContent = message;
    }

    // 复制房间ID到剪贴板
    function copyRoomIdToClipboard() {
      if (!state.roomId) return;
      
      // 复制房间ID
      elements.roomId.select();
      document.execCommand('copy');
      
      // 显示提示
      const originalText = elements.copyRoomId.innerHTML;
      elements.copyRoomId.innerHTML = '<i class="fa fa-check mr-1"></i> 已复制';
      
      setTimeout(() => {
        elements.copyRoomId.innerHTML = originalText;
      }, 2000);
    }

    // 添加参与者
    function addParticipant() {
      if (!state.isConnected) return;
      
      const name = elements.participantName.value.trim();
      
      if (!name) {
        showToast('请输入参与者姓名', 'warning');
        return;
      }
      
      if (state.participants.includes(name)) {
        showToast('该参与者已存在', 'warning');
        return;
      }
      
      if (state.participants.length >= 30) {
        showToast('最多只能添加30名参与者', 'warning');
        return;
      }
      
      // 更新本地数组
      const newParticipants = [...state.participants, name];
      
      // 更新数据库
      state.roomRef.update({
        participants: newParticipants
      });
      
      elements.participantName.value = '';
      showToast(`已添加: ${name}`, 'success');
    }

    // 渲染参与者列表
    function renderParticipants() {
      elements.participantCount.textContent = `${state.participants.length}人`;
      
      if (state.participants.length === 0) {
        elements.participantsContainer.innerHTML = `
          <div class="text-center text-gray-400 py-8 border border-dashed border-gray-200 rounded-lg">
            <i class="fa fa-users text-3xl mb-2 opacity-30"></i>
            <p>暂无参与者，请添加</p>
          </div>
        `;
        return;
      }
      
      elements.participantsContainer.innerHTML = '';
      
      state.participants.forEach((name, index) => {
        const participantEl = document.createElement('div');
        participantEl.className = 'flex justify-between items-center p-2 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors';
        participantEl.innerHTML = `
          <div class="flex items-center">
            <span class="inline-flex items-center justify-center w-6 h-6 bg-primary/10 text-primary rounded-full text-xs mr-2">${index + 1}</span>
            <span>${name}</span>
          </div>
          <button class="delete-participant text-gray-400 hover:text-red-500 p-1 transition-colors" data-index="${index}">
            <i class="fa fa-times"></i>
          </button>
        `;
        
        elements.participantsContainer.appendChild(participantEl);
      });
      
      // 添加删除事件监听
      document.querySelectorAll('.delete-participant').forEach(button => {
        button.addEventListener('click', (e) => {
          const index = parseInt(e.currentTarget.dataset.index);
          const deletedName = state.participants[index];
          
          // 创建新数组（不修改原数组）
          const newParticipants = [...state.participants];
          newParticipants.splice(index, 1);
          
          // 更新数据库
          state.roomRef.update({
            participants: newParticipants
          });
          
          showToast(`已移除: ${deletedName}`, 'info');
        });
      });
    }

    // 清空参与者
    function clearParticipants() {
      if (!state.isConnected) return;
      
      if (confirm('确定要清空所有参与者吗？')) {
        // 更新数据库
        state.roomRef.update({
          participants: []
        });
        
        showToast('已清空所有参与者', 'info');
      }
    }

    // 开始抽签
    function startDraw() {
      if (!state.isConnected) return;
      
      if (state.participants.length < 1) {
        showToast('请先添加参与者', 'warning');
        return;
      }
      
      if (state.isDrawing) return;
      
      state.isDrawing = true;
      elements.startDraw.disabled = true;
      elements.startDraw.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i> 抽签中...';
      
      // 动画效果：快速切换显示不同的参与者
      const drawResult = elements.drawResult;
      drawResult.innerHTML = '';
      drawResult.classList.add('border-primary');
      
      const interval = 50; // 切换速度，毫秒
      const duration = 3000; // 总时长，毫秒
      const totalSteps = duration / interval;
      let step = 0;
      
      const drawInterval = setInterval(() => {
        step++;
        // 随机选择一个参与者
        const randomIndex = Math.floor(Math.random() * state.participants.length);
        const randomParticipant = state.participants[randomIndex];
        
        // 更新显示
        drawResult.innerHTML = `
          <div class="text-center">
            <div class="text-2xl font-bold text-gray-700">${randomParticipant}</div>
          </div>
        `;
        
        // 结束抽签
        if (step >= totalSteps) {
          clearInterval(drawInterval);
          state.isDrawing = false;
          const winner = randomParticipant;
          
          // 显示最终结果
          drawResult.innerHTML = `
            <div class="text-center">
              <div class="inline-block p-2 bg-accent/10 rounded-full mb-2">
                <i class="fa fa-trophy text-3xl text-accent"></i>
              </div>
              <div class="text-3xl font-bold text-gray-800 animate-bounce-slow">${winner}</div>
              <div class="text-gray-500 mt-1">恭喜中奖！</div>
            </div>
          `;
          
          // 添加到历史记录
          const now = new Date();
          const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
          
          const newHistory = [
            {
              winner,
              time: timeStr,
              timestamp: now.getTime()
            },
            ...state.history
          ].slice(0, 20); // 只保留最近20条
          
          // 更新数据库
          state.roomRef.update({
            history: newHistory
          });
          
          // 恢复按钮状态
          elements.startDraw.disabled = false;
          elements.startDraw.innerHTML = '<i class="fa fa-play mr-2"></i> 开始抽签';
          
          showToast(`恭喜 ${winner} 中奖！`, 'success');
        }
      }, interval);
    }

    // 渲染历史记录
    function renderHistory() {
      elements.clearHistory.disabled = state.history.length === 0;
      
      if (state.history.length === 0) {
        elements.historyContainer.innerHTML = `
          <div class="text-center text-gray-400 py-6 border border-dashed border-gray-200 rounded-lg">
            <p>暂无抽签记录</p>
          </div>
        `;
        return;
      }
      
      elements.historyContainer.innerHTML = '';
      
      state.history.forEach((record, index) => {
        const historyItem = document.createElement('div');
        historyItem.className = `p-3 rounded-lg ${index === 0 ? 'bg-accent/5 border border-accent/20' : 'bg-gray-50'}`;
        historyItem.innerHTML = `
          <div class="flex justify-between items-center">
            <div>
              <div class="font-medium">${record.winner}</div>
              <div class="text-xs text-gray-500">${record.time}</div>
            </div>
            ${index === 0 ? '<span class="bg-accent/10 text-accent text-xs px-2 py-0.5 rounded-full">最新</span>' : ''}
          </div>
        `;
        
        elements.historyContainer.appendChild(historyItem);
      });
    }

    // 清空历史记录
    function clearHistory() {
      if (!state.isConnected) return;
      
      if (confirm('确定要清空所有抽签历史吗？')) {
        // 更新数据库
        state.roomRef.update({
          history: []
        });
        
        showToast('已清空抽签历史', 'info');
      }
    }

    // 打开批量导入模态框
    function openImportModal() {
      if (!state.isConnected) return;
      
      elements.importModal.classList.remove('hidden');
      // 触发动画
      setTimeout(() => {
        elements.modalContent.classList.remove('scale-95', 'opacity-0');
        elements.modalContent.classList.add('scale-100', 'opacity-100');
      }, 10);
      elements.batchNames.focus();
    }

    // 关闭批量导入模态框
    function closeImportModal() {
      elements.modalContent.classList.remove('scale-100', 'opacity-100');
      elements.modalContent.classList.add('scale-95', 'opacity-0');
      setTimeout(() => {
        elements.importModal.classList.add('hidden');
        elements.batchNames.value = '';
      }, 300);
    }

    // 导入参与者
    function importParticipants() {
      if (!state.isConnected) return;
      
      const text = elements.batchNames.value.trim();
      
      if (!text) {
        showToast('请输入参与者姓名', 'warning');
        return;
      }
      
      // 按行分割，过滤空行和重复项
      const names = text.split('\n')
        .map(name => name.trim())
        .filter(name => name)
        .filter((name, index, self) => self.indexOf(name) === index);
      
      if (names.length === 0) {
        showToast('未找到有效的参与者姓名', 'warning');
        return;
      }
      
      // 检查总数量是否超过限制
      const totalAfterImport = state.participants.length + names.length;
      if (totalAfterImport > 30) {
        showToast(`导入后将超过30人限制，当前可导入${30 - state.participants.length}人`, 'warning');
        return;
      }
      
      // 过滤掉已存在的参与者
      const newNames = names.filter(name => !state.participants.includes(name));
      
      if (newNames.length === 0) {
        showToast('所有参与者已存在', 'info');
        closeImportModal();
        return;
      }
      
      // 添加新参与者
      const updatedParticipants = [...state.participants, ...newNames];
      
      // 更新数据库
      state.roomRef.update({
        participants: updatedParticipants
      });
      
      showToast(`已成功导入 ${newNames.length} 名参与者`, 'success');
      
      closeImportModal();
    }

    // 更新按钮状态
    function updateButtonsState() {
      const hasParticipants = state.participants.length > 0;
      elements.clearParticipants.disabled = !hasParticipants;
      elements.startDraw.disabled = !hasParticipants || state.isDrawing || !state.isConnected;
    }

    // 显示提示消息
    function showToast(message, type = 'info') {
      // 检查是否已有toast，如有则移除
      const existingToast = document.querySelector('.toast-notification');
      if (existingToast) {
        existingToast.remove();
      }
      
      // 创建toast元素
      const toast = document.createElement('div');
      
      // 设置样式和图标
      let bgColor, icon;
      switch (type) {
        case 'success':
          bgColor = 'bg-secondary';
          icon = 'fa-check-circle';
          break;
        case 'warning':
          bgColor = 'bg-accent';
          icon = 'fa-exclamation-triangle';
          break;
        case 'error':
          bgColor = 'bg-red-500';
          icon = 'fa-times-circle';
          break;
        default:
          bgColor = 'bg-primary';
          icon = 'fa-info-circle';
      }
      
      toast.className = `toast-notification fixed bottom-4 right-4 ${bgColor} text-white px-4 py-3 rounded-lg shadow-lg transform translate-y-10 opacity-0 transition-all duration-300 z-50 flex items-center`;
      toast.innerHTML = `
        <i class="fa ${icon} mr-2"></i>
        <span>${message}</span>
      `;
      
      // 添加到页面
      document.body.appendChild(toast);
      
      // 显示动画
      setTimeout(() => {
        toast.classList.remove('translate-y-10', 'opacity-0');
        toast.classList.add('translate-y-0', 'opacity-100');
      }, 10);
      
      // 3秒后自动消失
      setTimeout(() => {
        toast.classList.remove('translate-y-0', 'opacity-100');
        toast.classList.add('translate-y-10', 'opacity-0');
        
        setTimeout(() => {
          toast.remove();
        }, 300);
      }, 3000);
    }

    // 切换主题
    function toggleTheme() {
      const isDark = document.body.classList.toggle('dark-mode');
      const icon = elements.themeToggle.querySelector('i');
      
      if (isDark) {
        document.body.classList.add('bg-gray-900', 'text-white');
        document.body.classList.remove('bg-gradient-to-br', 'from-blue-50', 'to-indigo-50', 'text-dark');
        icon.classList.remove('fa-moon-o');
        icon.classList.add('fa-sun-o');
      } else {
        document.body.classList.remove('bg-gray-900', 'text-white');
        document.body.classList.add('bg-gradient-to-br', 'from-blue-50', 'to-indigo-50', 'text-dark');
        icon.classList.remove('fa-sun-o');
        icon.classList.add('fa-moon-o');
      }
    }

    // 启动应用
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
